# DJI Tello 无人机控制系统技术文档

## 📋 目录
1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [核心模块详解](#核心模块详解)
4. [辅助模块](#辅助模块)
5. [测试模块](#测试模块)
6. [依赖项与环境配置](#依赖项与环境配置)
7. [使用指南](#使用指南)

---

## 项目概述

本项目是一个基于DJI Tello无人机的智能控制系统，集成了计算机视觉、深度学习和自动控制技术。系统支持手势识别、人体姿态检测、目标跟踪、PID控制等多种功能，可实现无人机的智能化自主飞行控制。

**主要技术栈：**
- Python 3.x
- OpenCV (计算机视觉)
- PyTorch (深度学习框架)
- YOLOv5 (目标检测)
- MediaPipe (人体关键点检测)
- djitellopy (Tello SDK封装)

---

## 系统架构

```
无人机控制系统
├── 视觉处理层
│   ├── YOLO目标检测
│   ├── MediaPipe姿态识别
│   └── 图像采集与预处理
├── 控制算法层
│   ├── PID控制器
│   ├── 状态机管理
│   └── 飞行指令生成
└── 硬件通信层
    └── Tello SDK通信
```

---

## 核心模块详解

### 1. 主程序模块 - `8.final.py`
**文件路径：** `d:\无人机\code\8.final.py`  
**代码行数：** 775行  
**模块作用：** 系统的主入口程序，集成所有功能的完整实现

**核心功能：**
- **多进程架构**：使用multiprocessing实现视频处理和飞行控制的并行执行
- **YOLO手势识别**：识别6种预定义手势动作（巳、未、申、亥、午、寅）作为起飞触发条件
- **人体姿态跟踪**：基于MediaPipe检测33个人体关键点，实现人体跟踪
- **PID三轴控制**：
  - 上下控制（高度锁定）
  - 偏航控制（yaw角度锁定）
  - 前后控制（距离保持）
- **状态机管理**：8种飞行状态（准备、起飞、锁定、前后左右移动、追踪、降落）
- **动作识别**：基于骨骼点位置识别8种静态动作指令
- **实时信息显示**：FPS、电量、状态、误差值等

**关键类与方法：**
```python
class Ai_tello:
    - __init__(): 初始化Tello、加载模型、设置PID参数
    - flightControl(): 飞行控制主进程
    - cameraProcess(): 视频流处理进程
    - updatePid(): 更新PID控制输出
    - processKeyPoints(): 绘制人体骨骼点
    - action2command(): 动作识别转飞行指令
    - drawInfo(): 绘制界面信息
```

**PID参数配置：**
- 上下调整：Kp=0.33, Ki=0.02, Kd=0
- 偏航旋转：Kp=0.1, Ki=0.01, Kd=0
- 前后调整：Kp=0.35, Ki=0, Kd=0.03

---

### 2. 高度偏航锁定模块 - `7.height_yaw_lock.py`
**文件路径：** `d:\无人机\code\7.height_yaw_lock.py`  
**代码行数：** 458行  
**模块作用：** 实现无人机高度和偏航角的精确锁定控制

**核心功能：**
- **双轴PID控制**：高度和偏航角独立PID调节
- **实时参数调节**：通过键盘实时调整PID参数（q/a调P，w/s调I，e/d调D）
- **误差计算**：计算镜头中心与双肩中心点的上下、左右误差
- **可视化调试**：显示PID参数和控制状态

**关键变量：**
- `dist_up_down_error`: 上下误差距离（共享变量）
- `dist_left_right_error`: 左右误差距离（共享变量）
- `pid_up_down_output`: 上下PID输出
- `pid_yaw_output`: 偏航PID输出

---

### 3. 人体关键点检测模块 - `6.body_keypoints_demo.py`
**文件路径：** `d:\无人机\code\6.body_keypoints_demo.py`  
**代码行数：** 105行  
**模块作用：** 演示MediaPipe人体关键点检测功能

**核心功能：**
- 检测33个人体关键点
- 绘制骨骼连接线（32条连接）
- 实时显示关键点位置

**关键点连接定义：**
```python
connections = [
    [0,1], [1,2], [2,3], [3,7],  # 头部
    [0,4], [4,5], [5,6], [6,8],  # 头部
    [9,10], [11,12],              # 肩部
    [12,14], [14,16], ...         # 右臂
    [11,13], [13,15], ...         # 左臂
    [12,24], [24,26], ...         # 右腿
    [11,23], [23,25], ...         # 左腿
]
```

---

### 4. 起飞控制模块 - `5.take_off.py`
**文件路径：** `d:\无人机\code\5.take_off.py`  
**代码行数：** 196行  
**模块作用：** 基于手势序列识别的起飞控制系统

**核心功能：**
- **手势序列验证**：需要按顺序完成6个手势动作才能起飞
- **状态机管理**：`yolo_action_status`列表记录每个动作完成状态
- **PNG标签显示**：在检测框上叠加中文标签图片
- **多进程控制**：分离视频处理和飞行控制

**手势动作映射：**
```python
yolo_action_seq = ['takeoff','forward','back','left','right','landoff']
palm_action = {
    'takeoff':'巳', 'forward':'未', 'back':'申',
    'left':'亥', 'right':'午', 'landoff':'寅'
}
```

---

### 5. YOLO目标检测模块 - `3.yolo_test.py`
**文件路径：** `d:\无人机\code\3.yolo_test.py`  
**代码行数：** 69行  
**模块作用：** 基于YOLOv5的实时目标检测（Tello版本）

**核心功能：**
- 加载自定义训练的YOLOv5模型
- 实时检测Tello视频流中的目标
- 绘制检测框和置信度
- 置信度阈值：0.7

**模型配置：**
- 模型路径：`./weights/last_best.pt`
- 框架：YOLOv5（本地加载）
- 输入：Tello视频流（镜像翻转）

---

### 6. YOLO本地摄像头测试 - `3.yolo_test_benji.py`
**文件路径：** `d:\无人机\code\3.yolo_test_benji.py`  
**代码行数：** 61行  
**模块作用：** 使用本地摄像头测试YOLO模型（不连接无人机）

**核心功能：**
- 使用电脑摄像头进行目标检测
- 适用于模型调试和离线测试
- 与Tello版本功能相同，但数据源不同

---

### 7. 图像采集模块 - `2.image_collect.py`
**文件路径：** `d:\无人机\code\2.image_collect.py`  
**代码行数：** 53行  
**模块作用：** 从Tello视频流采集训练图像

**核心功能：**
- 定时采集：每隔1秒采集一张图片
- 标签管理：按label_id分类保存
- 电量监控：实时显示无人机电量
- 自动命名：格式为`{label_id}_{index}.jpg`

**使用示例：**
```python
collect = Collect()
collect.main(label_id=1, count=15)  # 采集标签1的15张图片
```

---

### 8. SDK基础演示 - `1.sdk_dome.py`
**文件路径：** `d:\无人机\code\1.sdk_dome.py`  
**代码行数：** 56行  
**模块作用：** Tello SDK基础功能演示

**核心功能：**
- **视频流显示**：实时显示Tello摄像头画面
- **基础飞行控制**：起飞、移动、降落
- **电量查询**：显示无人机电池电量

**飞行演示流程：**
1. 起飞
2. 向上飞30cm
3. 向左飞30cm
4. 向右飞30cm
5. 等待3秒
6. 降落

---

### 9. 多进程演示模块 - `4.process_demo.py`
**文件路径：** `d:\无人机\code\4.process_demo.py`  
**代码行数：** 34行  
**模块作用：** 演示Python多进程和共享变量的使用

**核心功能：**
- 演示主进程和子进程通信
- 对比普通变量和共享变量（Value）的区别
- 为多进程飞行控制提供技术基础

**关键概念：**
- `share_value`: 普通变量（进程间不共享）
- `exchange_val`: 共享变量（进程间共享）

---

## 辅助模块

### 1. PID控制器 - `PID.py`
**文件路径：** `d:\无人机\code\PID.py`  
**代码行数：** 52行  
**模块作用：** 实现简单PID控制算法

**核心功能：**
- **PID计算**：P（比例）+ I（积分）+ D（微分）
- **参数调节**：动态修改Kp、Ki、Kd参数
- **输出限幅**：限制输出在指定范围内

**PID公式：**
```
output = Kp * error + Ki * integral + Kd * derivative
```

**关键方法：**
- `__init__(pid_paras_list)`: 初始化PID参数
- `setParas(which, add_val)`: 调整参数
- `update(current_error, min_val, max_val)`: 更新输出

---

### 2. 关键点检测封装 - `KEYPOINTS.py`
**文件路径：** `d:\无人机\code\KEYPOINTS.py`  
**代码行数：** 23行  
**模块作用：** MediaPipe人体姿态检测的封装类

**核心功能：**
- 封装MediaPipe Pose模型
- 简化关键点检测调用
- 配置检测和跟踪置信度阈值

**配置参数：**
- `min_detection_confidence`: 0.5
- `min_tracking_confidence`: 0.5

---

### 3. 飞行控制模块 - `flightcontrol.py`
**文件路径：** `d:\无人机\code\flightcontrol.py`  
**代码行数：** 125行  
**模块作用：** 基于YOLO检测结果的飞行控制

**核心功能：**
- 手势到飞行指令的映射
- 实时目标检测和指令执行
- 函数字典映射控制

**指令映射：**
```python
select_fuc = {
    "forward": forward,   # 前进20cm
    "back": back,         # 后退20cm
    "left": left,         # 左移20cm
    "right": right,       # 右移20cm
    "up": up,             # 上升20cm
    "down": down,         # 下降20cm
    "takeoff": takeoff,   # 起飞
    "landoff": landoff    # 降落
}
```

---

### 4. 手势控制模块 - `gesture control.py`
**文件路径：** `d:\无人机\code\gesture control.py`  
**代码行数：** 132行  
**模块作用：** 基于线程的手势控制系统

**核心功能：**
- **线程架构**：视频处理和指令执行分离
- **命令队列**：使用queue.Queue缓存检测结果
- **事件同步**：threading.Event控制执行时序
- **高度判断**：根据飞行高度执行不同指令

**控制逻辑：**
- 高度<5cm：只响应起飞指令
- 高度≥5cm：响应所有移动和降落指令

---

### 5. Tello原始控制 - `Tello3(1).py`
**文件路径：** `d:\无人机\code\Tello3(1).py`  
**代码行数：** 77行  
**模块作用：** Tello SDK的底层UDP通信实现

**核心功能：**
- UDP Socket通信（端口9000）
- 命令行交互控制
- 接收Tello响应数据

**通信配置：**
- 本地地址：('', 9000)
- Tello地址：('192.168.10.1', 8889)

---

### 6. PNG标签生成器 - `generate_txt_png.py`
**文件路径：** `d:\无人机\code\generate_txt_png.py`  
**代码行数：** 38行  
**模块作用：** 生成中文标签PNG图片

**核心功能：**
- 生成透明背景PNG图片
- 支持中文字体渲染
- 可选颜色（绿色/粉色）

**使用场景：**
- 生成手势动作标签
- 生成状态信息标签
- 生成误差显示标签

---

## 测试模块

### 1. 基础测试 - `test.py`
**文件路径：** `d:\无人机\code\test.py`  
**代码行数：** 78行  
**功能：** 简单的手势控制测试，单线程实现

---

### 2. 多进程测试 - `test1.py`
**文件路径：** `d:\无人机\code\test1.py`  
**代码行数：** 137行  
**功能：** 测试多进程架构，但存在进程通信问题

---

### 3. 共享变量测试 - `test2.py`
**文件路径：** `d:\无人机\code\test2.py`  
**代码行数：** 95行  
**功能：** 使用Value共享变量进行进程间通信

---

### 4. 线程锁测试 - `test3.py`
**文件路径：** `d:\无人机\code\test3.py`  
**代码行数：** 99行  
**功能：** 使用threading.Lock实现线程同步

---

### 5. 系统信息测试 - `test4.py`
**文件路径：** `d:\无人机\code\test4.py`  
**代码行数：** 118行  
**功能：** 获取CPU、内存、GPU、系统信息

**检测内容：**
- CPU核心数、频率、使用率
- 内存总量、可用量、使用率
- GPU信息（支持NVIDIA和Apple M1）
- 操作系统版本信息

---

### 6. YOLOv8测试 - `testyolov8.py`
**文件路径：** `d:\无人机\code\testyolov8.py`  
**代码行数：** 33行  
**功能：** 测试YOLOv8模型（使用ultralytics库）

**配置：**
- 置信度阈值：0.25
- IOU阈值：0.8
- 支持边框和遮罩绘制

---

## 依赖项与环境配置

### Python依赖包
```
opencv-python>=4.5.0
djitellopy>=2.3.0
torch>=1.9.0
mediapipe>=0.8.0
numpy>=1.19.0
Pillow>=8.0.0
pandas>=1.2.0
psutil>=5.8.0
GPUtil>=1.4.0 (可选)
ultralytics>=8.0.0 (YOLOv8)
```

### 目录结构
```
code/
├── weights/              # 模型权重文件
│   └── last_best.pt     # YOLOv5训练模型
├── yolov5/              # YOLOv5源代码
├── trainingImages/      # 训练图像存储
├── png_label/           # PNG标签图片
├── fonts/               # 字体文件
│   └── msyh.ttf        # 微软雅黑字体
└── djitellopy/          # Tello SDK库
```

### 硬件要求
- **无人机**：DJI Tello / Tello EDU
- **计算机**：支持WiFi连接
- **摄像头**：用于本地测试（可选）
- **GPU**：推荐NVIDIA GPU用于YOLO推理加速

---

## 使用指南

### 1. 环境准备
```bash
# 安装依赖
pip install opencv-python djitellopy torch mediapipe numpy pillow pandas

# 下载YOLOv5
git clone https://github.com/ultralytics/yolov5.git
```

### 2. 连接Tello
1. 打开Tello电源
2. 连接到Tello的WiFi网络（TELLO-XXXXXX）
3. 等待连接稳定

### 3. 运行主程序
```bash
# 完整功能（手势识别+姿态跟踪+PID控制）
python 8.final.py

# 高度偏航锁定测试
python 7.height_yaw_lock.py

# 基础手势控制
python "gesture control.py"

# YOLO目标检测测试
python 3.yolo_test.py
```

### 4. 采集训练数据
```bash
python 2.image_collect.py
# 修改代码中的label_id和count参数
```

### 5. PID参数调节
在`8.final.py`或`7.height_yaw_lock.py`运行时：
- **X键**：切换到上下PID
- **C键**：切换到偏航PID
- **Q/A键**：增加/减少P参数
- **W/S键**：增加/减少I参数
- **E/D键**：增加/减少D参数

### 6. 飞行控制指令（8.final.py）
**起飞前：**
1. 按顺序完成6个手势动作
2. 系统自动起飞并上升50cm

**起飞后：**
- **状态1**：高度偏航锁定
- **状态2**：向前移动
- **状态3**：向后移动
- **状态4**：向左移动
- **状态5**：向右移动
- **状态6**：自动追踪（保持距离150cm）
- **状态7**：手掌降落（靠近到100cm后降落）
- **状态8**：立即降落

**动作识别：**
- 双手上举：进入追踪模式
- 双手向上交叉：手掌降落
- 双手向下交叉：立即降落
- 右手收敛：向前
- 右手外放：向后
- 左手收敛：向左
- 左手外放：向右

---

## 安全注意事项

⚠️ **重要提醒：**
1. 在室内空旷环境测试，避免障碍物
2. 首次运行建议在地面测试，不要起飞
3. 随时准备按'Q'键退出程序
4. 保持无人机电量充足（>20%）
5. 测试PID参数时从小幅度调整开始
6. 确保WiFi连接稳定
7. 保持在Tello的有效控制范围内（10米）

---

## 技术特点总结

### 优势
✅ 多进程并行处理，提高响应速度  
✅ PID闭环控制，实现精确定位  
✅ 状态机管理，逻辑清晰可靠  
✅ 模块化设计，易于扩展维护  
✅ 实时可视化，便于调试监控  

### 创新点
🔹 手势序列验证起飞机制  
🔹 骨骼点动作识别控制  
🔹 三轴PID协同控制  
🔹 距离估算与自动追踪  
🔹 中文标签可视化界面  

---

## 版本信息
- **文档版本**：v1.0
- **创建日期**：2024
- **适用系统**：Windows / macOS / Linux
- **Python版本**：3.6+

---

## 联系与支持
如有问题或建议，请参考代码注释或联系开发团队。

**文档结束**
